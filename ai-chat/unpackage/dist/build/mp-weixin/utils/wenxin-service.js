"use strict";const e=require("../common/vendor.js"),t=require("./ai-config.js");const s=new class{constructor(){this.accessToken=""}getPlatform(){return"mp-weixin"}getBaseUrl(){return"h5"===this.getPlatform()?"/api":"https://aip.baidubce.com"}async getAccessToken(){try{const s=`${this.getBaseUrl()}/oauth/2.0/token?grant_type=client_credentials&client_id=${t.config.API_KEY}&client_secret=${t.config.SECRET_KEY}`,{data:c}=await e.index.request({url:s,method:"POST",header:{"Content-Type":"application/json",Accept:"application/json"}});if(c.access_token)return this.accessToken=c.access_token,this.accessToken;throw new Error("获取access_token失败")}catch(s){throw console.error("获取access_token错误:",s),s}}async chat(t){try{this.accessToken||await this.getAccessToken();const s=`${this.getBaseUrl()}/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions?access_token=${this.accessToken}`,{data:c}=await e.index.request({url:s,method:"POST",header:{"Content-Type":"application/json"},data:{messages:t}});if(c.error_code){if(110===c.error_code||111===c.error_code)return this.accessToken="",this.chat(t);throw new Error(c.error_msg)}return c.result}catch(s){throw console.error("调用文心一言API错误:",s),s}}};exports.chatWithWenxin=e=>s.chat(e);
